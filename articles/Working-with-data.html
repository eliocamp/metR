<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Working with data • metR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Working with data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">metR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.18.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Visualization-tools.html">Visualization tools</a></li>
    <li><a class="dropdown-item" href="../articles/Working-with-data.html">Working with data</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/eliocamp/metR/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Working with data</h1>
                        <h4 data-toc-skip class="author">Elio
Campitelli</h4>
            
            <h4 data-toc-skip class="date">2025-07-28</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/eliocamp/metR/blob/main/vignettes/Working-with-data.Rmd" class="external-link"><code>vignettes/Working-with-data.Rmd</code></a></small>
      <div class="d-none name"><code>Working-with-data.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="getting-data">Getting data<a class="anchor" aria-label="anchor" href="#getting-data"></a>
</h2>
<p><code>metR</code> implements some functions to easily load data into
R either from local files or from remote locations.</p>
<div class="section level3">
<h3 id="readnetcdf">ReadNetCDF<a class="anchor" aria-label="anchor" href="#readnetcdf"></a>
</h3>
<p>The function <code><a href="../reference/ReadNetCDF.html">ReadNetCDF()</a></code> relies on the
<code>ncdf4</code> package to read NetCDF files with ease. It
intelligently reads dimensions and data and returns a tidy
<code>data.table</code> with optional keyed columns for faster
processing afterwards. It can also return an <code>array</code> with
named dimensions or a <code>vector</code>, for the case of adding new
columns to an existing <code>data.table</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://eliocamp.github.io/metR/">metR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># If out = "vars", returns information about the available variables and </span></span>
<span><span class="co"># dimensions</span></span>
<span><span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"temperature.nc"</span>, package <span class="op">=</span> <span class="st">"metR"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/ReadNetCDF.html">GlanceNetCDF</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span></span>
<span><span class="co">#&gt; ----- Variables ----- </span></span>
<span><span class="co">#&gt; air:</span></span>
<span><span class="co">#&gt;     mean Daily Air temperature in degK</span></span>
<span><span class="co">#&gt;     Dimensions: lon by lat by level by time</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ----- Dimensions ----- </span></span>
<span><span class="co">#&gt;   time: 1 values from 2010-07-09 to 2010-07-09 </span></span>
<span><span class="co">#&gt;   level: 17 values from 10 to 1000 millibar</span></span>
<span><span class="co">#&gt;   lat: 73 values from -90 to 90 degrees_north</span></span>
<span><span class="co">#&gt;   lon: 144 values from 0 to 357.5 degrees_east</span></span></code></pre></div>
<p>Now that we know the name and the dimensions of the data, we can read
it. <code><a href="../reference/ReadNetCDF.html">ReadNetCDF()</a></code> can also read only a (continuous) subset
of the data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">air</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ReadNetCDF.html">ReadNetCDF</a></span><span class="op">(</span><span class="va">file</span>, subset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lat <span class="op">=</span> <span class="fl">90</span><span class="op">:</span><span class="fl">0</span>, level <span class="op">=</span> <span class="fl">925</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">air</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/geom_contour2.html">geom_contour2</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>z <span class="op">=</span> <span class="va">air</span>, color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_eval.html" class="external-link">after_stat</a></span><span class="op">(</span><span class="va">level</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Working-with-data_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
<p>Since the most consuming part of reading the file is melting a
multidimensional array into a tidy <code>data.table</code>, if we wanted
to add another variable to the same <code>data.table</code> we could
save time by only returning a vector. <strong>It is of the utmost
importance that both variables are on the same exact grid</strong>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">air</span><span class="op">[</span>, <span class="va">air2</span> <span class="op">:=</span> <span class="fu"><a href="../reference/ReadNetCDF.html">ReadNetCDF</a></span><span class="op">(</span><span class="va">file</span>, out <span class="op">=</span> <span class="st">"vector"</span>,</span>
<span>                         subset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lat <span class="op">=</span> <span class="fl">90</span><span class="op">:</span><span class="fl">0</span>, level <span class="op">=</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">air</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/geom_contour2.html">geom_contour2</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>z <span class="op">=</span> <span class="va">air2</span>, color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_eval.html" class="external-link">after_stat</a></span><span class="op">(</span><span class="va">level</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Working-with-data_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
<p>Because <code><a href="../reference/ReadNetCDF.html">ReadNetCDF()</a></code> can read multiple variables at the
same time, the <code>out = "vector"</code> output will be actually
return a <code>list</code> of vectors (which integrates seamlessly with
the <code>data.table</code> syntax). If one of the variables has
degenerate dimensions (dimensions of length 1) then it will be recycled.
That means that if the same file has Sea Surface Temperatures (a 2D
field) and Air Temperature (a 3D field), then the returned
<code>data.table</code> fill have an observation of Air Temperature
<em>and</em> Sea Surface Temperature for each vertical level.</p>
<p>The netCDF format is very flexible and this function has not been
tested on every possible file so things may break in strange cases. If
you have a file that cannot be read with this function, please <a href="https://github.com/eliocamp/metR/issues" class="external-link">submit an issue</a>.</p>
</div>
<div class="section level3">
<h3 id="gettopography">GetTopography<a class="anchor" aria-label="anchor" href="#gettopography"></a>
</h3>
<p><code><a href="../reference/GetTopography.html">GetTopography()</a></code> retrieves topographic data from the
ETOPO1 Global Relief Model into a convenient tidy
<code>data.table</code>. By default, it also stores a cached
version.</p>
<p>As an example, let’s look at a global relief map at 1/2° resolution
with some ugly colour palette.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Not run because it needs internet access</span></span>
<span><span class="co"># world &lt;- GetTopography(0, 360, 90, -90, resolution = 1)</span></span>
<span></span>
<span><span class="co"># ggplot(world, aes(lon, lat)) +</span></span>
<span><span class="co">#     geom_raster(aes(fill = h/1000)) +</span></span>
<span><span class="co">#     geom_contour2(aes(z = h), breaks = 0, color = "black", size = 0.5) +</span></span>
<span><span class="co">#     coord_fixed(expand = FALSE) +</span></span>
<span><span class="co">#     scale_fill_gradientn(colors = topo.colors(6)[c(1, 2, 3, 4, 6)], </span></span>
<span><span class="co">#                          values = scales::rescale(c(-11, 0, 0, 2, 7)),</span></span>
<span><span class="co">#                          guide = "none") +</span></span>
<span><span class="co">#     theme_void()</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="maskland">MaskLand<a class="anchor" aria-label="anchor" href="#maskland"></a>
</h3>
<p>Related to this problem, <code><a href="../reference/MaskLand.html">MaskLand()</a></code> returns a logical
vector with <code>TRUE</code> if a point is over land.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">air</span><span class="op">[</span>, <span class="va">land</span> <span class="op">:=</span> <span class="fu"><a href="../reference/MaskLand.html">MaskLand</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">air</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">land</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_map.html" class="external-link">coord_quickmap</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Working-with-data_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
<p>With this, we can compare mean temperature over land and over sea by
latitude.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">air</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>air <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">air</span><span class="op">)</span> <span class="op">-</span> <span class="fl">273.15</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">lat</span>, <span class="va">land</span><span class="op">)</span><span class="op">]</span>,</span>
<span>       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">lat</span>, <span class="va">air</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">land</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Working-with-data_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
<p>The resolution of <code><a href="../reference/MaskLand.html">MaskLand()</a></code> is, in principle, only
limited by the polygons used as mask. Currently it can only use maps
from the <code>maps</code> package (see <code><a href="https://rdrr.io/pkg/maps/man/map.html" class="external-link">?maps::map</a></code>).</p>
</div>
</div>
<div class="section level2">
<h2 id="manipulate-data">Manipulate data<a class="anchor" aria-label="anchor" href="#manipulate-data"></a>
</h2>
<div class="section level3">
<h3 id="eof">EOF<a class="anchor" aria-label="anchor" href="#eof"></a>
</h3>
<p>Empirical Orthogonal Functions (also known as Principal Component
Analysis) is a widely use technique for dimensional reduction of large
datasets. In R there are multiple packages that implement this
methodology (in fact, base R has <em>two</em> functions) but, IMHO, they
have awkward interfaces that don’t interact well with
<code>data.table</code> (or <code>dplyr</code>) syntax.
<code>metR</code>’s <code><a href="../reference/EOF.html">EOF()</a></code> essentially performs a Singular
Value Decomposition of the data and returns the left and right singular
vectors, and singular values in a tidy format.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">geopotential</span><span class="op">)</span></span>
<span><span class="co"># Weigthed geopotential anomaly</span></span>
<span><span class="va">geopotential</span><span class="op">[</span>, <span class="va">gh.t.w</span> <span class="op">:=</span> <span class="fu"><a href="../reference/Anomaly.html">Anomaly</a></span><span class="op">(</span><span class="va">gh</span><span class="op">)</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cos</a></span><span class="op">(</span><span class="va">lat</span><span class="op">*</span><span class="va">pi</span><span class="op">/</span><span class="fl">180</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span>, <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/IDateTime.html" class="external-link">month</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">eof</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EOF.html">EOF</a></span><span class="op">(</span><span class="va">gh.t.w</span> <span class="op">~</span> <span class="va">date</span> <span class="op">|</span> <span class="va">lon</span> <span class="op">+</span> <span class="va">lat</span>, data <span class="op">=</span> <span class="va">geopotential</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">eof</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 3</span></span>
<span><span class="co">#&gt;  $ left :Classes 'data.table' and 'data.frame':  144 obs. of  3 variables:</span></span>
<span><span class="co">#&gt;   ..$ date  : Date[1:144], format: "1990-01-01" "1990-02-01" ...</span></span>
<span><span class="co">#&gt;   ..$ PC    : Ord.factor w/ 2 levels "PC1"&lt;"PC2": 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   ..$ gh.t.w: num [1:144] 0.0633 -0.1145 -0.0432 0.1926 0.1539 ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, ".internal.selfref")=&lt;externalptr&gt; </span></span>
<span><span class="co">#&gt;  $ right:Classes 'data.table' and 'data.frame':  8064 obs. of  4 variables:</span></span>
<span><span class="co">#&gt;   ..$ lon   : num [1:8064] 0 2.5 5 7.5 10 12.5 15 17.5 20 22.5 ...</span></span>
<span><span class="co">#&gt;   ..$ lat   : num [1:8064] -22.5 -22.5 -22.5 -22.5 -22.5 -22.5 -22.5 -22.5 -22.5 -22.5 ...</span></span>
<span><span class="co">#&gt;   ..$ PC    : Ord.factor w/ 2 levels "PC1"&lt;"PC2": 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   ..$ gh.t.w: num [1:8064] 2.32e-04 4.67e-06 -1.17e-04 -1.47e-04 -1.12e-04 ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, ".internal.selfref")=&lt;externalptr&gt; </span></span>
<span><span class="co">#&gt;  $ sdev :Classes 'data.table' and 'data.frame':  2 obs. of  3 variables:</span></span>
<span><span class="co">#&gt;   ..$ PC: Ord.factor w/ 2 levels "PC1"&lt;"PC2": 1 2</span></span>
<span><span class="co">#&gt;   ..$ sd: num [1:2] 7050 4228</span></span>
<span><span class="co">#&gt;   ..$ r2: num [1:2] 0.318 0.114</span></span>
<span><span class="co">#&gt;   ..- attr(*, ".internal.selfref")=&lt;externalptr&gt; </span></span>
<span><span class="co">#&gt;  - attr(*, "call")= language EOF(formula = gh.t.w ~ date | lon + lat, n = 1:2, data = geopotential)</span></span>
<span><span class="co">#&gt;  - attr(*, "class")= chr [1:2] "eof" "list"</span></span>
<span><span class="co">#&gt;  - attr(*, "suffix")= chr "PC"</span></span>
<span><span class="co">#&gt;  - attr(*, "value.var")= chr "gh.t.w"</span></span>
<span><span class="co">#&gt;  - attr(*, "engine")=function (A, nv, nu)</span></span></code></pre></div>
<p>In the returned list of <code>data.table</code>s the left (right)
singular vectors are fields defined with the dimensions on the left
(right) hand of the formula. In this case, the right
<code>data.table</code> holds spatial fields and the left
<code>data.table</code> holds a timeseries. If the order of the right
hand side and left hand side of the formula are reversed, and
<code>rotate == FALSE</code>, then the result is the same. Rotation of
the singular vectors is perform via <code><a href="https://rdrr.io/r/stats/varimax.html" class="external-link">stats::varimax()</a></code> and
perform from the (scaled) right singular vector.</p>
<p>For completion, let’s plot each Principal Component.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">eof</span><span class="op">$</span><span class="va">right</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/geom_contour_fill.html">geom_contour_fill</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>z <span class="op">=</span> <span class="va">gh.t.w</span><span class="op">)</span>, binwidth <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/scale_divergent.html">scale_fill_divergent</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_polar.html" class="external-link">coord_polar</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">PC</span><span class="op">)</span> </span></code></pre></div>
<p><img src="Working-with-data_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">eof</span><span class="op">$</span><span class="va">left</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">gh.t.w</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">PC</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="Working-with-data_files/figure-html/unnamed-chunk-8-2.png" width="672"></p>
<p>Where the 1st Principal Component is clearly the <a href="http://www.cpc.ncep.noaa.gov/products/precip/CWlink/daily_ao_index/aao/aao.shtml" class="external-link">Antarctic
Oscillation</a> and the 2nd Principal Component looks like the
Pacific–South American Pattern.</p>
</div>
<div class="section level3">
<h3 id="imputeeof">ImputeEOF<a class="anchor" aria-label="anchor" href="#imputeeof"></a>
</h3>
<p>As shown above, <code><a href="../reference/EOF.html">EOF()</a></code> needs a complete data matrix.
Imputing missing values is a huge problem on it’s own with a lot of
different algorithms. <code>metR</code> offers <code><a href="../reference/ImputeEOF.html">ImputeEOF()</a></code>,
which is an implementation of the <a href="https://doi.org/10.12681/mms.64" class="external-link">DINEOF</a> algorithm for
imputation of missing data. Its interface is similar to that of
<code><a href="../reference/EOF.html">EOF()</a></code> but it returns a vector of imputed values.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">geopotential</span> <span class="op">&lt;-</span> <span class="va">geopotential</span><span class="op">[</span><span class="op">]</span></span>
<span><span class="va">geopotential</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">.N</span>, <span class="va">.N</span><span class="op">*</span><span class="fl">0.8</span><span class="op">)</span>, <span class="va">gh.na</span> <span class="op">:=</span> <span class="va">gh</span><span class="op">]</span></span>
<span></span>
<span><span class="va">geopotential</span><span class="op">[</span>, <span class="va">imputed</span> <span class="op">:=</span> <span class="fu"><a href="../reference/ImputeEOF.html">ImputeEOF</a></span><span class="op">(</span><span class="va">gh.na</span> <span class="op">~</span> <span class="va">lon</span> <span class="op">+</span> <span class="va">lat</span> <span class="op">|</span> <span class="va">date</span>, max.eof <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">geopotential</span><span class="op">)</span></span>
<span><span class="co">#&gt; Classes 'data.table' and 'data.frame':   290304 obs. of  8 variables:</span></span>
<span><span class="co">#&gt;  $ lon    : num  0 2.5 5 7.5 10 12.5 15 17.5 20 22.5 ...</span></span>
<span><span class="co">#&gt;  $ lat    : num  -22.5 -22.5 -22.5 -22.5 -22.5 -22.5 -22.5 -22.5 -22.5 -22.5 ...</span></span>
<span><span class="co">#&gt;  $ lev    : int  700 700 700 700 700 700 700 700 700 700 ...</span></span>
<span><span class="co">#&gt;  $ gh     : num  3164 3163 3162 3162 3163 ...</span></span>
<span><span class="co">#&gt;  $ date   : Date, format: "1990-01-01" "1990-01-01" ...</span></span>
<span><span class="co">#&gt;  $ gh.t.w : num  -3.82 -3.59 -2.86 -2.4 -2.07 ...</span></span>
<span><span class="co">#&gt;  $ gh.na  : num  3164 3163 3162 3162 3163 ...</span></span>
<span><span class="co">#&gt;  $ imputed: num  3164 3163 3162 3162 3163 ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, "eof")= int 5</span></span>
<span><span class="co">#&gt;   ..- attr(*, "rmse")= num 26.6</span></span>
<span><span class="co">#&gt;  - attr(*, ".internal.selfref")=&lt;externalptr&gt;</span></span></code></pre></div>
<p>The imputed vector is returned along with the Root Mean Square Error
estimated from cross-validation and the number of EOFs used in the
imputation as attributes. In this case, with 5 EOFs the imputed values
have an estimated rmse of 26.65.</p>
</div>
<div class="section level3">
<h3 id="interpolate">Interpolate<a class="anchor" aria-label="anchor" href="#interpolate"></a>
</h3>
<p><code><a href="../reference/Interpolate.html">Interpolate()</a></code> performs linear interpolation using a
<code>data.table</code>-friendly syntax. It can be used to a new grid or
to add interpolated values to an existing grid. It’s easy to interpolate
multiple values with the formula interface.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># new grid</span></span>
<span><span class="va">x.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">360</span>, by <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">y.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">90</span>, <span class="fl">0</span>, by <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">interpolated</span> <span class="op">&lt;-</span> <span class="va">geopotential</span><span class="op">[</span>, <span class="fu"><a href="../reference/Interpolate.html">Interpolate</a></span><span class="op">(</span><span class="va">gh</span> <span class="op">|</span> <span class="va">gh.t.w</span> <span class="op">~</span> <span class="va">lon</span> <span class="op">+</span> <span class="va">lat</span>, <span class="va">x.out</span>, <span class="va">y.out</span><span class="op">)</span>, </span>
<span>                             by <span class="op">=</span> <span class="va">date</span><span class="op">]</span></span></code></pre></div>
<p>To add interpolated values to an existing <code>data.table</code> use
<code>grid = FALSE</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">geopotential</span><span class="op">[</span>, <span class="va">gh.new</span> <span class="op">:=</span> <span class="fu"><a href="../reference/Interpolate.html">Interpolate</a></span><span class="op">(</span><span class="va">gh</span> <span class="op">~</span> <span class="va">lon</span> <span class="op">+</span> <span class="va">lat</span>, <span class="va">lon</span>, <span class="va">lat</span>, </span>
<span>                                     data <span class="op">=</span> <span class="va">interpolated</span><span class="op">[</span><span class="va">date</span> <span class="op">==</span> <span class="va">d</span><span class="op">]</span>,</span>
<span>                                     grid <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">gh</span>, </span>
<span>             by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span>d <span class="op">=</span> <span class="va">date</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="physics">Physics<a class="anchor" aria-label="anchor" href="#physics"></a>
</h2>
<div class="section level3">
<h3 id="derivates">Derivates<a class="anchor" aria-label="anchor" href="#derivates"></a>
</h3>
<p>Derivation is the bread and butter of the researcher so
<code><a href="../reference/Derivate.html">Derivate()</a></code> offers a convenient interface for derivation
using finite differences of multidimensional data. It has support for
cyclical boundary conditions and for the special case of spherical
coordinates (think: Earth).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">geopotential</span><span class="op">[</span><span class="va">date</span> <span class="op">==</span> <span class="va">date</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,    <span class="co"># think: gh as a function of lon and lat</span></span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gh.dlon"</span>, <span class="st">"gh.dlat"</span><span class="op">)</span> <span class="op">:=</span> <span class="fu"><a href="../reference/Derivate.html">Derivate</a></span><span class="op">(</span><span class="va">gh</span> <span class="op">~</span> <span class="va">lon</span> <span class="op">+</span> <span class="va">lat</span>, </span>
<span>                                                 cyclical <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span>, </span>
<span>                                                 sphere <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">geopotential</span><span class="op">[</span><span class="va">date</span> <span class="op">==</span> <span class="va">date</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/geom_contour_fill.html">geom_contour_fill</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>z <span class="op">=</span> <span class="va">gh</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/geom_arrow.html">geom_vector</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>dx <span class="op">=</span> <span class="va">gh.dlon</span>, dy <span class="op">=</span> <span class="va">gh.dlat</span><span class="op">)</span>, skip <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/scale_mag.html">scale_mag</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_map.html" class="external-link">coord_quickmap</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Working-with-data_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<p>There are several wrappers around <code><a href="../reference/Derivate.html">Derivate()</a></code> to perform
other common related operations, <code><a href="../reference/Derivate.html">Laplacian()</a></code>,
<code><a href="../reference/Derivate.html">Divergence()</a></code> and <code><a href="../reference/Derivate.html">Vorticity()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="geostrophicwind">GeostrophicWind<a class="anchor" aria-label="anchor" href="#geostrophicwind"></a>
</h3>
<p>Finally, the function <code><a href="../reference/GeostrophicWind.html">GeostrophicWind()</a></code> computes
geostrophic wind from geopotential height.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">geopotential</span><span class="op">[</span><span class="va">date</span> <span class="op">==</span> <span class="va">date</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"u"</span>, <span class="st">"v"</span><span class="op">)</span> <span class="op">:=</span> <span class="fu"><a href="../reference/GeostrophicWind.html">GeostrophicWind</a></span><span class="op">(</span><span class="va">gh</span>, <span class="va">lon</span>, <span class="va">lat</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">geopotential</span><span class="op">[</span><span class="va">date</span> <span class="op">==</span> <span class="va">date</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/geom_contour2.html">geom_contour2</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>z <span class="op">=</span> <span class="va">gh</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/geom_arrow.html">geom_vector</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>dx <span class="op">=</span> <span class="fu"><a href="../reference/spherical.html">dlon</a></span><span class="op">(</span><span class="va">u</span>, <span class="va">lat</span><span class="op">)</span>, dy <span class="op">=</span> <span class="fu"><a href="../reference/spherical.html">dlat</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">)</span>, </span>
<span>              skip.y <span class="op">=</span> <span class="fl">1</span>, skip.x <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/scale_mag.html">scale_mag</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_map.html" class="external-link">coord_quickmap</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="Working-with-data_files/figure-html/unnamed-chunk-13-1.png" width="672"></p>
</div>
<div class="section level3">
<h3 id="thermodynamics">Thermodynamics<a class="anchor" aria-label="anchor" href="#thermodynamics"></a>
</h3>
<p><code>metR</code> offers several functions related to thermodynamical
processes in the atmosphere (see <code><a href="../reference/thermodynamics.html">?thermodynamics</a></code>). These
are <code><a href="../reference/thermodynamics.html">IdealGas()</a></code>, <code><a href="../reference/thermodynamics.html">Adiabat()</a></code>,
<code><a href="../reference/thermodynamics.html">VirtualTemperature()</a></code>, <code><a href="../reference/thermodynamics.html">MixingRatio()</a></code>,
<code><a href="../reference/thermodynamics.html">ClausiusClapeyron()</a></code> and <code><a href="../reference/thermodynamics.html">DewPoint()</a></code>. Each
function represents a different physical relationship between variables
and computes one of them from the others.</p>
<p>For example, <code><a href="../reference/thermodynamics.html">IdealGas()</a></code> uses the ideal gas law to
compute pressure, temperature or density.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Density of air at 20°C and 1030hPa.</span></span>
<span><span class="op">(</span><span class="va">rho</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/thermodynamics.html">IdealGas</a></span><span class="op">(</span><span class="fl">1013</span><span class="op">*</span><span class="fl">100</span>, <span class="fl">20</span> <span class="op">+</span> <span class="fl">273.15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.203788</span></span>
<span></span>
<span><span class="co"># Of course, the temperature of air at that density </span></span>
<span><span class="co"># and same pressure is 20°C.</span></span>
<span><span class="fu"><a href="../reference/thermodynamics.html">IdealGas</a></span><span class="op">(</span><span class="fl">1013</span><span class="op">*</span><span class="fl">100</span>, rho <span class="op">=</span> <span class="va">rho</span><span class="op">)</span> <span class="op">-</span> <span class="fl">273.15</span></span>
<span><span class="co">#&gt; [1] 20</span></span></code></pre></div>
<p>Different variables can be derived by combining these functions. For
example, it’s easy to calculate relative humidity from data on
temperature and dewpoint, then saturation mixing ratio from pressure and
temperature and finally the actual mixing ratio.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Relative humidity from T and Td</span></span>
<span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fl">25</span> <span class="op">+</span> <span class="fl">273.15</span></span>
<span><span class="va">td</span> <span class="op">&lt;-</span> <span class="fl">20</span> <span class="op">+</span> <span class="fl">273.15</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">1000000</span></span>
<span><span class="op">(</span><span class="va">rh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/thermodynamics.html">ClausiusClapeyron</a></span><span class="op">(</span><span class="va">td</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="../reference/thermodynamics.html">ClausiusClapeyron</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.7380251</span></span>
<span></span>
<span><span class="co"># Mixing ratio</span></span>
<span><span class="va">ws</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/thermodynamics.html">MixingRatio</a></span><span class="op">(</span><span class="va">p</span>, <span class="fu"><a href="../reference/thermodynamics.html">ClausiusClapeyron</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">w</span> <span class="op">&lt;-</span> <span class="va">ws</span><span class="op">*</span><span class="va">rh</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.001456004</span></span></code></pre></div>
<p>Of course, <code>w</code> can be also be computed by
<code>DewPoint(p, td = td)</code> which gives essentially the same
result: 0.0014548.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Elio Campitelli.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
