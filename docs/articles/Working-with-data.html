<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Working with data • metR</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><meta property="og:title" content="Working with data">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">metR</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Visualization-tools.html">Visualization tools</a>
    </li>
    <li>
      <a href="../articles/Working-with-data.html">Working with data</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/eliocamp/metR">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Working with data</h1>
                        <h4 class="author">Elio Campitelli</h4>
            
            <h4 class="date">2018-04-18</h4>
      
      <small>Source: <a href="https://github.com/eliocamp/metR/blob/master/vignettes/Working-with-data.Rmd"><code>vignettes/Working-with-data.Rmd</code></a></small>

    </div>

    
    
<div class="contents">
<div id="getting-data" class="section level1">
<h1 class="hasAnchor">
<a href="#getting-data" class="anchor"></a>Getting data</h1>
<p><code>metR</code> implements some functions to easily load data into R either from local files or from remote locations.</p>
<div id="readnetcdf" class="section level2">
<h2 class="hasAnchor">
<a href="#readnetcdf" class="anchor"></a>ReadNetCDF</h2>
<p>The function <code><a href="../reference/ReadNetCDF.html">ReadNetCDF()</a></code> relies on the <code>ncdf4</code> package to read netCDF files with ease. It intelligently reads dimensions and data and returns a tidy <code>data.table</code> with optional keyed columns for faster processing afterwards. It can also return an <code>array</code> with named dimensions or a <code>vector</code>, for the case of adding new columns to an existing <code>data.table</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(metR)
<span class="kw">library</span>(data.table)
<span class="kw">library</span>(ggplot2)

<span class="co"># If out = "vars", returns information about the available variables and </span>
<span class="co"># dimensions</span>
file &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"temperature.nc"</span>, <span class="dt">package =</span> <span class="st">"metR"</span>)
<span class="kw">str</span>(<span class="kw"><a href="../reference/ReadNetCDF.html">ReadNetCDF</a></span>(file, <span class="dt">out =</span> <span class="st">"vars"</span>))
<span class="co">#&gt; List of 2</span>
<span class="co">#&gt;  $ vars      : chr "air"</span>
<span class="co">#&gt;  $ dimensions:List of 4</span>
<span class="co">#&gt;   ..$ time : chr "2010-07-09"</span>
<span class="co">#&gt;   ..$ level: num [1:17(1d)] 1000 925 850 700 600 500 400 300 250 200 ...</span>
<span class="co">#&gt;   ..$ lat  : num [1:73(1d)] 90 87.5 85 82.5 80 77.5 75 72.5 70 67.5 ...</span>
<span class="co">#&gt;   ..$ lon  : num [1:144(1d)] 0 2.5 5 7.5 10 12.5 15 17.5 20 22.5 ...</span></code></pre></div>
<p>Now that we know the name and the dimensions of the data, we can read it. <code><a href="../reference/ReadNetCDF.html">ReadNetCDF()</a></code> can also read only a (continuous) subset of the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">air &lt;-<span class="st"> </span><span class="kw"><a href="../reference/ReadNetCDF.html">ReadNetCDF</a></span>(file, <span class="dt">subset =</span> <span class="kw">list</span>(<span class="dt">lat =</span> <span class="dv">90</span><span class="op">:</span><span class="dv">0</span>, <span class="dt">level =</span> <span class="dv">925</span>))


<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(air, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(lon, lat)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_contour">geom_contour</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">z =</span> air, <span class="dt">color =</span> ..level..))</code></pre></div>
<p><img src="Working-with-data_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
<p>Since the most consumig part of reading the file is melting a multidimensinal array into a tidy <code>data.table</code>, if we wanted to add another variable to the same <code>data.table</code> we could save time by only returning a vector. <strong>It is of the upmost importance that both variables are on the same exact grid</strong>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">air[, air2 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/ReadNetCDF.html">ReadNetCDF</a></span>(file, <span class="dt">out =</span> <span class="st">"vector"</span>,
                         <span class="dt">subset =</span> <span class="kw">list</span>(<span class="dt">lat =</span> <span class="dv">90</span><span class="op">:</span><span class="dv">0</span>, <span class="dt">level =</span> <span class="dv">300</span>))]

<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(air, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(lon, lat)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_contour">geom_contour</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">z =</span> air2, <span class="dt">color =</span> ..level..))</code></pre></div>
<p><img src="Working-with-data_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
<p>Because <code><a href="../reference/ReadNetCDF.html">ReadNetCDF()</a></code> can read multiple variables at the same time, the <code>out = "vector"</code> output will be actually return a <code>list</code> of vectors (which integrates seamlessly with the <code>data.table</code> syntax). If one of the variables has degenerate dimensions (dimensions of length 1) then it will be recicled. That means that if the same file has Sea Surface Temperatures (a 2D field) and Air Temperature (a 3D field), then the returned <code>data.table</code> fill have an observation of Air Temperature <em>and</em> Sea Surface Temperature for each vertical level.</p>
<p>The netCDF format is very flexible and this function has not been tested on every posible file so things may break in strange cases. If you have a file that cannot be read with this function, please <a href="https://github.com/eliocamp/metR/issues">submit an issue</a>.</p>
</div>
<div id="gettopography" class="section level2">
<h2 class="hasAnchor">
<a href="#gettopography" class="anchor"></a>GetTopography</h2>
<p><code><a href="../reference/GetTopography.html">GetTopography()</a></code> retrieves topographic data from the <a href="https://www.ngdc.noaa.gov/mgg/global/global.html">ETOPO1 Global Relief Model</a> into a convenient tidy <code>data.table</code>. By defualt, it also stores a cached version.</p>
<p>As an example, let’s look at a global relief map at 1/2° resolution with some ugly color palette.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">world &lt;-<span class="st"> </span><span class="kw"><a href="../reference/GetTopography.html">GetTopography</a></span>(<span class="dv">0</span>, <span class="dv">360</span>, <span class="dv">90</span>, <span class="op">-</span><span class="dv">90</span>, <span class="dt">resolution =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">2</span>)

<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(world, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(lon, lat)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_tile">geom_raster</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">fill =</span> h<span class="op">/</span><span class="dv">1000</span>)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_contour">geom_contour</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">z =</span> h), <span class="dt">breaks =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">"black"</span>, <span class="dt">size =</span> <span class="fl">0.5</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/coord_fixed">coord_fixed</a></span>(<span class="dt">expand =</span> <span class="ot">FALSE</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/scale_gradient">scale_fill_gradientn</a></span>(<span class="dt">colors =</span> <span class="kw">topo.colors</span>(<span class="dv">6</span>)[<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">6</span>)], 
                         <span class="dt">values =</span> scales<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/scales/topics/rescale">rescale</a></span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">11</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">7</span>)),
                         <span class="dt">guide =</span> <span class="st">"none"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_void</a></span>()</code></pre></div>
<p><img src="Working-with-data_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
</div>
<div id="maskland" class="section level2">
<h2 class="hasAnchor">
<a href="#maskland" class="anchor"></a>MaskLand</h2>
<p>Related to this problem, <code><a href="../reference/MaskLand.html">MaskLand()</a></code> returns a logical vector with <code>TRUE</code> if a point is over land.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">air[, land <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/MaskLand.html">MaskLand</a></span>(lon, lat)]

<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(air, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(lon, lat)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_tile">geom_tile</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">fill =</span> land)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/coord_map">coord_quickmap</a></span>()</code></pre></div>
<p><img src="Working-with-data_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
<p>With this, we can compare mean temperature over land and over sea by latitude.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(air[, .(<span class="dt">air =</span> <span class="kw">mean</span>(air) <span class="op">-</span><span class="st"> </span><span class="fl">273.15</span>), <span class="dt">by =</span> .(lat, land)],
       <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(lat, air)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_path">geom_line</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">color =</span> land))</code></pre></div>
<p><img src="Working-with-data_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
<p>The resolution of <code><a href="../reference/MaskLand.html">MaskLand()</a></code> is, in principle, only limited by the polygons used as mask. Currently it can only use maps from the <code>maps</code> package (see <code><a href="http://www.rdocumentation.org/packages/maps/topics/map">?maps::map</a></code>).</p>
</div>
<div id="getsmndata" class="section level2">
<h2 class="hasAnchor">
<a href="#getsmndata" class="anchor"></a>GetSMNData</h2>
<p>Finally, <code><a href="../reference/GetSMNData.html">GetSMNData()</a></code> retrieves data from Argentina’s National Weather Service’s public access. This is a rapidly evolving project, and data availability is not guaranteed. Currently available data are hourly station data, daily station maximum and minimum temperature, and global and diffuse radiation measured at Buenos Aires and Ushuaia.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rad &lt;-<span class="st"> </span><span class="kw"><a href="../reference/GetSMNData.html">GetSMNData</a></span>(<span class="kw">as.Date</span>(<span class="st">"2018-03-15"</span>), <span class="dt">type =</span> <span class="st">"radiation"</span>)

<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(rad, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(date, global)) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_path">geom_line</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">color =</span> station))</code></pre></div>
<p><img src="Working-with-data_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
</div>
</div>
<div id="manipulate-data" class="section level1">
<h1 class="hasAnchor">
<a href="#manipulate-data" class="anchor"></a>Manipulate data</h1>
<div id="eof" class="section level2">
<h2 class="hasAnchor">
<a href="#eof" class="anchor"></a>EOF</h2>
<p>Empirical Orthogonal Functions (also known as Principal Component Analysis) is a widely use technique for dimensional reduction of large datasets. In R there are multiple packages that implement this methodology (in fact, base R has <em>two</em> functions) but, IMHO, they have akward interfaces that don’t interact well with <code>data.table</code> (or <code>dplyr</code>) syntax. <code>metR</code>’s <code><a href="../reference/EOF.html">EOF()</a></code> essentially performs a Singular Value Decomposition of the data and returns the U, V and D matrices in a tidy format.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(geopotential)
<span class="co"># Weigthed geopotential anomaly</span>
geopotential[, gh.t.w <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/Anomaly.html">Anomaly</a></span>(gh)<span class="op">*</span><span class="kw">sqrt</span>(<span class="kw">cos</span>(lat<span class="op">*</span>pi<span class="op">/</span><span class="dv">180</span>)), by =<span class="st"> </span>.(lon, lat, <span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/IDateTime">month</a></span>(date))]

eof &lt;-<span class="st"> </span><span class="kw"><a href="../reference/EOF.html">EOF</a></span>(gh.t.w <span class="op">~</span><span class="st"> </span>date <span class="op">|</span><span class="st"> </span>lon <span class="op">+</span><span class="st"> </span>lat, <span class="dt">data =</span> geopotential, <span class="dt">n =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)
<span class="kw">str</span>(eof)
<span class="co">#&gt; List of 3</span>
<span class="co">#&gt;  $ right:Classes 'data.table' and 'data.frame':  8064 obs. of  4 variables:</span>
<span class="co">#&gt;   ..$ lon   : num [1:8064] 0 0 0 0 0 0 0 0 0 0 ...</span>
<span class="co">#&gt;   ..$ lat   : num [1:8064] -90 -87.5 -85 -82.5 -80 -77.5 -75 -72.5 -70 -67.5 ...</span>
<span class="co">#&gt;   ..$ PC    : Factor w/ 2 levels "PC1","PC2": 1 1 1 1 1 1 1 1 1 1 ...</span>
<span class="co">#&gt;   ..$ gh.t.w: num [1:8064] 2.86e-10 6.78e-03 9.44e-03 1.23e-02 1.52e-02 ...</span>
<span class="co">#&gt;   ..- attr(*, ".internal.selfref")=&lt;externalptr&gt; </span>
<span class="co">#&gt;  $ left :Classes 'data.table' and 'data.frame':  264 obs. of  3 variables:</span>
<span class="co">#&gt;   ..$ date  : Date[1:264], format: "1990-01-01" ...</span>
<span class="co">#&gt;   ..$ PC    : Factor w/ 2 levels "PC1","PC2": 1 1 1 1 1 1 1 1 1 1 ...</span>
<span class="co">#&gt;   ..$ gh.t.w: num [1:264] 0.0668 -0.0897 -0.0198 0.1765 0.1711 ...</span>
<span class="co">#&gt;   ..- attr(*, ".internal.selfref")=&lt;externalptr&gt; </span>
<span class="co">#&gt;  $ sdev :Classes 'data.table' and 'data.frame':  2 obs. of  3 variables:</span>
<span class="co">#&gt;   ..$ PC: Factor w/ 2 levels "PC1","PC2": 1 2</span>
<span class="co">#&gt;   ..$ sd: num [1:2] 9295 6056</span>
<span class="co">#&gt;   ..$ r2: num [1:2] 0.278 0.118</span>
<span class="co">#&gt;   ..- attr(*, ".internal.selfref")=&lt;externalptr&gt;</span></code></pre></div>
<p>The returned list of <code>data.table</code>s hold the right and left singular vectors, and the singular values asociated with them. There’s no need to think about S or T mode, since both are calculated and returned. Always the right (left) singular vectors are fields defined with the dimensions on the right (left) hand of the formula. In this case, the right <code>data.table</code> holds spatial fields and the left <code>data.table</code> holds a timeseries.</p>
<p>If we invert the formula call, the result is identical (up to small numerical errors, maybe) but with the right and left singular vectors switched.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">eof2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/EOF.html">EOF</a></span>(gh.t.w <span class="op">~</span><span class="st"> </span>lat <span class="op">+</span><span class="st"> </span>lon <span class="op">|</span><span class="st"> </span>date, <span class="dt">data =</span> geopotential, <span class="dt">n =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)
<span class="kw">str</span>(eof2)
<span class="co">#&gt; List of 3</span>
<span class="co">#&gt;  $ right:Classes 'data.table' and 'data.frame':  264 obs. of  3 variables:</span>
<span class="co">#&gt;   ..$ date  : Date[1:264], format: "1990-01-01" ...</span>
<span class="co">#&gt;   ..$ PC    : Factor w/ 2 levels "PC1","PC2": 1 1 1 1 1 1 1 1 1 1 ...</span>
<span class="co">#&gt;   ..$ gh.t.w: num [1:264] -0.0668 0.0897 0.0198 -0.1765 -0.1711 ...</span>
<span class="co">#&gt;   ..- attr(*, ".internal.selfref")=&lt;externalptr&gt; </span>
<span class="co">#&gt;  $ left :Classes 'data.table' and 'data.frame':  8064 obs. of  4 variables:</span>
<span class="co">#&gt;   ..$ lat   : num [1:8064] -90 -90 -90 -90 -90 -90 -90 -90 -90 -90 ...</span>
<span class="co">#&gt;   ..$ lon   : num [1:8064] 0 2.5 5 7.5 10 12.5 15 17.5 20 22.5 ...</span>
<span class="co">#&gt;   ..$ PC    : Factor w/ 2 levels "PC1","PC2": 1 1 1 1 1 1 1 1 1 1 ...</span>
<span class="co">#&gt;   ..$ gh.t.w: num [1:8064] -2.86e-10 -2.86e-10 -2.86e-10 -2.86e-10 -2.86e-10 ...</span>
<span class="co">#&gt;   ..- attr(*, ".internal.selfref")=&lt;externalptr&gt; </span>
<span class="co">#&gt;  $ sdev :Classes 'data.table' and 'data.frame':  2 obs. of  3 variables:</span>
<span class="co">#&gt;   ..$ PC: Factor w/ 2 levels "PC1","PC2": 1 2</span>
<span class="co">#&gt;   ..$ sd: num [1:2] 9295 6056</span>
<span class="co">#&gt;   ..$ r2: num [1:2] 0.278 0.118</span>
<span class="co">#&gt;   ..- attr(*, ".internal.selfref")=&lt;externalptr&gt;</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sum</span>(eof2<span class="op">$</span>right<span class="op">$</span>gh.t.w <span class="op">-</span><span class="st"> </span>eof<span class="op">$</span>left<span class="op">$</span>gh.t.w)
<span class="co">#&gt; [1] -2.640671e-08</span></code></pre></div>
<p>Alternatively, <code><a href="../reference/EOF.html">EOF()</a></code> also accepts the (probably) more familiar <code>dcast</code> interface.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">eof2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/EOF.html">EOF</a></span>(lon <span class="op">+</span><span class="st"> </span>lat <span class="op">~</span><span class="st"> </span>date, <span class="dt">value.var =</span> <span class="st">"gh.t.w"</span>, <span class="dt">data =</span> geopotential, <span class="dt">n =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)</code></pre></div>
<p>For completion, let’s plot each Principal Component.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(eof<span class="op">$</span>right, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(lon, lat)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/geom_contour_fill.html">geom_contour_fill</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">z =</span> gh.t.w), <span class="dt">circular =</span> <span class="st">"x"</span>, <span class="dt">binwidth =</span> <span class="fl">0.01</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/scale_divergent.html">scale_fill_divergent</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/coord_polar">coord_polar</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/facet_wrap">facet_wrap</a></span>(<span class="op">~</span>PC) </code></pre></div>
<p><img src="Working-with-data_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="kw"><a href="../reference/DivideTimeseries.html">DivideTimeseries</a></span>(
    <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(eof<span class="op">$</span>left, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(date, gh.t.w)) <span class="op">+</span>
<span class="st">        </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_path">geom_line</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">color =</span> PC)) <span class="op">+</span>
<span class="st">        </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/scale_date">scale_x_date</a></span>(<span class="dt">expand =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">0</span>)), 
    eof<span class="op">$</span>left<span class="op">$</span>date, <span class="dt">n =</span> <span class="dv">2</span>, <span class="dt">xlab =</span> <span class="st">"date"</span>, <span class="dt">ylab =</span> <span class="st">"gh.t.w"</span>)</code></pre></div>
<p><img src="Working-with-data_files/figure-html/unnamed-chunk-12-2.png" width="672"></p>
<p>Where the 1st Principal Component is clearly the <a href="http://www.cpc.ncep.noaa.gov/products/precip/CWlink/daily_ao_index/aao/aao.shtml">Antarctic Oscillation</a> and the 2nd Principal Component looks like the Pacific–South American Pattern.</p>
<p><code><a href="../reference/EOF.html">EOF()</a></code> not only works for regular grids.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(claris)            <span class="co"># station data of max and min temperature</span>
<span class="kw">data</span>(claris.stations)   <span class="co"># info and location for each station</span>
<span class="co"># As any other singular value decomposition, EOF() does not </span>
<span class="co"># allow missing values</span>
claris[, max.t <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/Anomaly.html">Anomaly</a></span>(max), by =<span class="st"> </span>.(<span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/IDateTime">yday</a></span>(date), id)]
claris[<span class="kw">is.na</span>(max.t), max.t <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="dv">0</span>]

eof &lt;-<span class="st"> </span><span class="kw"><a href="../reference/EOF.html">EOF</a></span>(max.t <span class="op">~</span><span class="st"> </span>date <span class="op">|</span><span class="st"> </span>id, <span class="dt">data =</span> claris, <span class="dt">n =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)

eof<span class="op">$</span>right &lt;-<span class="st"> </span>eof<span class="op">$</span>right[claris.stations, on =<span class="st"> "id"</span>]   <span class="co"># join with geographical info</span>

<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(eof<span class="op">$</span>right, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(lon, lat)) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">color =</span> max.t, <span class="dt">size =</span> <span class="kw">abs</span>(max.t))) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/facet_wrap">facet_wrap</a></span>(<span class="op">~</span>PC) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/scale_divergent.html">scale_color_divergent</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/coord_map">coord_quickmap</a></span>()</code></pre></div>
<p><img src="Working-with-data_files/figure-html/unnamed-chunk-13-1.png" width="672"></p>
</div>
<div id="imputeeof" class="section level2">
<h2 class="hasAnchor">
<a href="#imputeeof" class="anchor"></a>ImputeEOF</h2>
<p>As shown above, <code><a href="../reference/EOF.html">EOF()</a></code> needs a complete data matrix. Imputing missing values is a huge problem on it’s own with a lot of different algorithms. <code>metR</code> offers <code><a href="../reference/ImputeEOF.html">ImputeEOF()</a></code>, which is an implementation of the <a href="http://modb.oce.ulg.ac.be/mediawiki/index.php/DINEOF">DINEOF</a> algorithm for imputation of missing data. It’s interface is similar to that of <code><a href="../reference/EOF.html">EOF()</a></code> but it returns a vector of imputed values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># reload claris with it's missing values</span>
<span class="kw">data</span>(claris)
claris[, max.t <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/Anomaly.html">Anomaly</a></span>(max, <span class="dt">na.rm =</span> T), by =<span class="st"> </span>.(<span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/IDateTime">yday</a></span>(date), id)]

claris[, imputed <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/ImputeEOF.html">ImputeEOF</a></span>(max.t <span class="op">~</span><span class="st"> </span>date <span class="op">|</span><span class="st"> </span>id)]
<span class="kw">str</span>(claris)
<span class="co">#&gt; Classes 'data.table' and 'data.frame':   241128 obs. of  6 variables:</span>
<span class="co">#&gt;  $ id     : int  10008 10008 10008 10008 10008 10008 10008 10008 10008 10008 ...</span>
<span class="co">#&gt;  $ date   : Date, format: "2000-01-01" "2000-01-02" ...</span>
<span class="co">#&gt;  $ max    : num  NA NA 33 31 30.5 29.8 30.3 25 NA 28.4 ...</span>
<span class="co">#&gt;  $ min    : num  NA NA 13.9 12.4 16.5 9 14 16.6 NA 15.4 ...</span>
<span class="co">#&gt;  $ max.t  : num  NA NA 3.173 0.4 0.533 ...</span>
<span class="co">#&gt;  $ imputed: atomic  2.936 1.936 3.173 0.4 0.533 ...</span>
<span class="co">#&gt;   ..- attr(*, "eof")= num 6</span>
<span class="co">#&gt;   ..- attr(*, "rmse")= num 1.92</span>
<span class="co">#&gt;  - attr(*, ".internal.selfref")=&lt;externalptr&gt;</span></code></pre></div>
<p>The imputed vector is returned along with the Root Mean Square Error estimated from crossvalidation and the number of EOFs used in the imputation as attributes. In this case, with 6 EOFs the imputed values have an estimated rmse of 1.92.</p>
</div>
<div id="interpolate" class="section level2">
<h2 class="hasAnchor">
<a href="#interpolate" class="anchor"></a>Interpolate</h2>
<p><code><a href="../reference/Interpolate.html">Interpolate()</a></code> is a convenient wrapper of <code><a href="http://www.rdocumentation.org/packages/fields/topics/interp.surface">fields::interp.surface()</a></code> that makes it work better inside <code>data.table</code>s. It can be used to a new grid or to add interpolated values to an existing grid. It’s easy to interpolate multiple values with the formula interface.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># new grid</span>
x.out &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">360</span>, <span class="dt">by =</span> <span class="dv">10</span>)
y.out &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">90</span>, <span class="dv">0</span>, <span class="dt">by =</span> <span class="dv">10</span>)

interpolated &lt;-<span class="st"> </span>geopotential[, <span class="kw"><a href="../reference/Interpolate.html">Interpolate</a></span>(gh <span class="op">|</span><span class="st"> </span>gh.t.w <span class="op">~</span><span class="st"> </span>lon <span class="op">+</span><span class="st"> </span>lat, x.out, y.out), 
                             by =<span class="st"> </span>date]</code></pre></div>
<p>To add interpolated values to an existing <code>data.table</code> use <code>grid = FALSE</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">geopotential[, gh.new <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/Interpolate.html">Interpolate</a></span>(gh <span class="op">~</span><span class="st"> </span>lon <span class="op">+</span><span class="st"> </span>lat, lon, lat, 
                                     <span class="dt">data =</span> interpolated[date <span class="op">==</span><span class="st"> </span>d],
                                     <span class="dt">grid =</span> <span class="ot">FALSE</span>)<span class="op">$</span>gh, 
             by =<span class="st"> </span>.(<span class="dt">d =</span> date)]</code></pre></div>
</div>
</div>
<div id="physics" class="section level1">
<h1 class="hasAnchor">
<a href="#physics" class="anchor"></a>Physics</h1>
<div id="derivates" class="section level2">
<h2 class="hasAnchor">
<a href="#derivates" class="anchor"></a>Derivates</h2>
<p>Derivation is the bread and butter of the researcher so <code><a href="../reference/Derivate.html">Derivate()</a></code> offers a convenient interface for derivation using finite differences of multidimensional data. It has support for cyclical boundary conditions and for the special case of spherical coordinates (think: Earth).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">geopotential[date <span class="op">==</span><span class="st"> </span>date[<span class="dv">1</span>],    <span class="co"># think: gh as a function of lon and lat</span>
    <span class="kw">c</span>(<span class="st">"gh.dlon"</span>, <span class="st">"gh.dlat"</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/Derivate.html">Derivate</a></span>(gh <span class="op">~</span><span class="st"> </span>lon <span class="op">+</span><span class="st"> </span>lat, 
                                        <span class="dt">cyclical =</span> <span class="kw">c</span>(<span class="ot">TRUE</span>, <span class="ot">FALSE</span>), 
                                        <span class="dt">sphere =</span> <span class="ot">TRUE</span>)]


<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(geopotential[date <span class="op">==</span><span class="st"> </span>date[<span class="dv">1</span>]], <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(lon, lat)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/geom_contour_fill.html">geom_contour_fill</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">z =</span> gh)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/geom_vector.html">geom_vector</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">dx =</span> gh.dlon, <span class="dt">dy =</span> gh.dlat), <span class="dt">skip =</span> <span class="dv">2</span>, 
                <span class="dt">scale =</span> <span class="fl">3e4</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/coord_map">coord_quickmap</a></span>()
<span class="co">#&gt; Warning: Removed 288 rows containing non-finite values (stat_vector).</span></code></pre></div>
<p><img src="Working-with-data_files/figure-html/unnamed-chunk-17-1.png" width="672"></p>
<p>There are several wrapers around <code><a href="../reference/Derivate.html">Derivate()</a></code> to perform other common related operations, <code><a href="../reference/Derivate.html">Laplacian()</a></code>, <code><a href="../reference/Derivate.html">Divergence()</a></code> and <code><a href="../reference/Derivate.html">Vorticity()</a></code>.</p>
</div>
<div id="geostrophicwind" class="section level2">
<h2 class="hasAnchor">
<a href="#geostrophicwind" class="anchor"></a>GeostrophicWind</h2>
<p>Finally, the function <code><a href="../reference/GeostrophicWind.html">GeostrophicWind()</a></code> computes geostrophic wind from geopotential height.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">geopotential[date <span class="op">==</span><span class="st"> </span>date[<span class="dv">1</span>], <span class="kw">c</span>(<span class="st">"u"</span>, <span class="st">"v"</span>) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/GeostrophicWind.html">GeostrophicWind</a></span>(gh, lon, lat)]

<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(geopotential[date <span class="op">==</span><span class="st"> </span>date[<span class="dv">1</span>]], <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(lon, lat)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_contour">geom_contour</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">z =</span> gh)) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="../reference/geom_vector.html">geom_vector</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">dx =</span> u, <span class="dt">dy =</span> v), <span class="dt">skip.y =</span> <span class="dv">1</span>, <span class="dt">skip.x =</span> <span class="dv">2</span>, <span class="dt">scale =</span> <span class="dv">1</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/coord_map">coord_quickmap</a></span>()
<span class="co">#&gt; Warning: Removed 288 rows containing non-finite values (stat_vector).</span></code></pre></div>
<p><img src="Working-with-data_files/figure-html/unnamed-chunk-18-1.png" width="672"></p>
</div>
<div id="thermodynamics" class="section level2">
<h2 class="hasAnchor">
<a href="#thermodynamics" class="anchor"></a>Thermodynamics</h2>
<p><code>metR</code> offers several functions related to thermodynamical processes in the atmosphere (see <code><a href="../reference/thermodynamics.html">?thermodynamics</a></code>). These are <code><a href="../reference/thermodynamics.html">IdealGas()</a></code>, <code><a href="../reference/thermodynamics.html">Adiabat()</a></code>, <code><a href="../reference/thermodynamics.html">VirtualTemperature()</a></code>, <code><a href="../reference/thermodynamics.html">MixingRatio()</a></code>, <code><a href="../reference/thermodynamics.html">ClausiusClapeyron()</a></code> and <code><a href="../reference/thermodynamics.html">DewPoint()</a></code>. Each function represents a different phisical relationship between variables and computes one of them from the others.</p>
<p>For example, <code><a href="../reference/thermodynamics.html">IdealGas()</a></code> uses the ideal gas law to compute pressure, temperature or density.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Density of air at 20°C and 1030hPa.</span>
(rho &lt;-<span class="st"> </span><span class="kw"><a href="../reference/thermodynamics.html">IdealGas</a></span>(<span class="dv">1013</span><span class="op">*</span><span class="dv">100</span>, <span class="dv">20</span> <span class="op">+</span><span class="st"> </span><span class="fl">273.15</span>))
<span class="co">#&gt; [1] 1.203788</span>

<span class="co"># Of course, the temperature of air at that density </span>
<span class="co"># and same pressure is 20°C.</span>
<span class="kw"><a href="../reference/thermodynamics.html">IdealGas</a></span>(<span class="dv">1013</span><span class="op">*</span><span class="dv">100</span>, <span class="dt">rho =</span> rho) <span class="op">-</span><span class="st"> </span><span class="fl">273.15</span>
<span class="co">#&gt; [1] 20</span></code></pre></div>
<p>Different variables can be derived by combining these functions. For example, it’s easy to calculate relative humidity from data on temperature and dewpoint, then saturation mixing ratio from pressure and temperature and finally the actual mixing ratio.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Relative humidity from T and Td</span>
t &lt;-<span class="st"> </span><span class="dv">25</span> <span class="op">+</span><span class="st"> </span><span class="fl">273.15</span>
td &lt;-<span class="st"> </span><span class="dv">20</span> <span class="op">+</span><span class="st"> </span><span class="fl">273.15</span>
p &lt;-<span class="st"> </span><span class="dv">1000000</span>
(rh &lt;-<span class="st"> </span><span class="kw"><a href="../reference/thermodynamics.html">ClausiusClapeyron</a></span>(td)<span class="op">/</span><span class="kw"><a href="../reference/thermodynamics.html">ClausiusClapeyron</a></span>(t))
<span class="co">#&gt; [1] 0.7380251</span>

<span class="co"># Mixing ratio</span>
ws &lt;-<span class="st"> </span><span class="kw"><a href="../reference/thermodynamics.html">MixingRatio</a></span>(p, <span class="kw"><a href="../reference/thermodynamics.html">ClausiusClapeyron</a></span>(t))
(w &lt;-<span class="st"> </span>ws<span class="op">*</span>rh)
<span class="co">#&gt; [1] 0.001456004</span></code></pre></div>
<p>Of course, <code>w</code> can be also be computed by <code><a href="../reference/thermodynamics.html">DewPoint(p, td = td)</a></code> which gives essentially the same result: 0.0014548.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#getting-data">Getting data</a><ul class="nav nav-pills nav-stacked">
<li><a href="#readnetcdf">ReadNetCDF</a></li>
      <li><a href="#gettopography">GetTopography</a></li>
      <li><a href="#maskland">MaskLand</a></li>
      <li><a href="#getsmndata">GetSMNData</a></li>
      </ul>
</li>
      <li>
<a href="#manipulate-data">Manipulate data</a><ul class="nav nav-pills nav-stacked">
<li><a href="#eof">EOF</a></li>
      <li><a href="#imputeeof">ImputeEOF</a></li>
      <li><a href="#interpolate">Interpolate</a></li>
      </ul>
</li>
      <li>
<a href="#physics">Physics</a><ul class="nav nav-pills nav-stacked">
<li><a href="#derivates">Derivates</a></li>
      <li><a href="#geostrophicwind">GeostrophicWind</a></li>
      <li><a href="#thermodynamics">Thermodynamics</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Elio Campitelli.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
